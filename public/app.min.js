/*!Thu May 09 2013 10:21:07 */
window.Puls3={},Puls3.Views={},Puls3.Collections={},Puls3.Models={},Puls3.Routers={},window.app={},window.routers={},window.plugs={},window.views={},window.collections={},Puls3.Models.ArticleModel=Backbone.Model.extend({urlRoot:"/articles",defaults:{},prettyDate:function(e){if(!e||"0000-00-00 00:00:00"===e)return"";var e=Date.parse(e);return e.toString("MMMM dd, yyyy")},parse:function(e){return e.data?e.data:e}}),Puls3.Models.Article=Puls3.Models.ArticleModel,Puls3.Collections.ArticlesCollection=Backbone.Collection.extend({model:Puls3.Models.ArticleModel,name:"articles",url:"",search:function(e){if(""==e)return this;var t=RegExp(e,"gi");return _(this.filter(function(e){return t.test(e.get("name"))}))},comparator:function(e){return e.get("name")},getOne:function(e){var t=this.filter(function(t){return t.get("id")==e});return t.length?t[0]:null},parse:function(e){return e.data}}),Puls3.Collections.Articles=Puls3.Collections.ArticlesCollection,Puls3.Views.ArticleView=Backbone.View.extend({events:{"click > article":"navigate","click .likes_up":"upvote","click .likes_down":"downvote"},className:"",initialize:function(e){var t=this;this.model=e,this.template=swig.compile($("#Article_tpl").html()),this.model.on("change",function(){t.render()})},render:function(){var e=this,t=e.model.toJSON();return this.$el.html(this.template({post:t})),this},upvote:function(e){e.preventDefault(),e.stopPropagation(),this.model.set("votes",parseInt(this.model.get("votes"),10)+1),this.model.save()},downvote:function(e){e.preventDefault(),e.stopPropagation(),this.model.set("votes",parseInt(this.model.get("votes"),10)-1),this.model.save()},navigate:function(){var e=this;Backbone.history.navigate("article/"+e.model.get("id"),{trigger:!0})}}),Puls3.Views.ArticleExtendedView=Backbone.View.extend({events:{"click .likes_up":"upvote","click .likes_down":"downvote"},className:"",initialize:function(e){var t=this;this.model=e,this.template=swig.compile($("#ArticleExtended_tpl").html()),this.model.on("change",function(){t.render()})},upvote:function(e){e.preventDefault(),this.model.set("votes",parseInt(this.model.get("votes"),10)+1),this.model.save()},downvote:function(e){e.preventDefault(),this.model.set("votes",parseInt(this.model.get("votes"),10)-1),this.model.save()},render:function(){var e=this,t=e.model.toJSON();return this.$el.html(this.template({post:t})),this}}),Puls3.Views.ArticleNewView=Backbone.View.extend({events:{"click button":"newArticle"},className:"",initialize:function(e){this.$el=e},newArticle:function(){var e=this.$el.find("#title").val(),t=this.$el.find("#content").val(),n=this.$el.find("#tag").val();if(e&&t&&n){var r=new Puls3.Models.ArticleModel({title:e,tag:n,content:t}),i=r.save();i.done(function(e){Backbone.history.navigate("article/"+e.id,{trigger:!0})})}else alert("Necesitas tener titulo, contenido y tag")}}),Puls3.Routers.BaseRouter=Backbone.Router.extend({routes:{"":"root","article/:id":"article"},initialize:function(){console.log("Base Router started")},root:function(){console.log("Root routes"),$("#contenido > div").remove(),window.app.state="root",window.collections.articles.forEach(function(e){var t=new Puls3.Views.ArticleView(e);t.render(),t.$el.insertAfter("#contenido aside")})},article:function(e){$("#contenido > div").remove(),window.app.state="article::single";var t=window.collections.articles.getOne(e);if(t){var n=new Puls3.Views.ArticleExtendedView(t);n.render(),n.$el.appendTo("#contenido")}else Backbone.history.navigate("",{trigger:!0})}}),$(document).ready(function(){console.log("Starting app"),window.routers.base=new Puls3.Routers.BaseRouter,window.collections.articles=new Puls3.Collections.Articles,window.views.newArticle=new Puls3.Views.ArticleNewView($("#contenido aside")),window.ponyExpress=new PonyExpress({io:window.location.origin}),window.ponyExpress.bind("connect",function(){window.plugs.article=new PonyExpress.BackbonePlug({collection:window.collections.articles})}),window.collections.articles.on("add",function(e){if("root"===window.app.state){var t=new Puls3.Views.ArticleView(e);t.render(),t.$el.insertAfter("#contenido aside")}});var e=$.get("/articles/all");e.done(function(e){e.forEach(function(e){window.collections.articles.add(e)}),Backbone.history.start({root:"/",pushState:!0,silent:!1})}),e.error(function(e){console.log("error",e)}),$("nav ul li:first").click(function(e){e.preventDefault(),Backbone.history.navigate("",{trigger:!0})})});